{% extends "base.jinja2" %}

{% block title %}LoginWeen{% endblock %}

{% block nav %}
<li class="nav-item">
    <a class="nav-link active" aria-current="page" href="/login">Login</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/register">Register</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/logout">Logout</a>
</li>
{% endblock %}

{% block body %}
<div class="position-absolute top-50 start-50 translate-middle text-center">
  <h1>LoginWeen: Draw your carving to log in!</h1>
  <canvas id="pumpkin_canvas" width="300" height="300" class="my-3"></canvas>
  <div class="buttons">
    <button type="button" class="btn btn-primary me-2" id="loginBtn">Login</button>
    <button id="clearBtn" class="btn btn-danger">Clear</button>
  </div>
</div>

<script>
const canvas = document.getElementById('pumpkin_canvas');
const ctx = canvas.getContext('2d');
const img = new Image();
img.src = '/static/pumpkin.png';

img.onload = () => {
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

let drawing = false;
let currentPattern = [];
let savedPattern = null;

canvas.addEventListener('mousedown', () => { drawing = true; });
canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
canvas.addEventListener('mousemove', draw);

function draw(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const imageData = ctx.getImageData(x, y, 1, 1);
    const pixel = imageData.data;

    const r = pixel[0];
    const g = pixel[1];
    const b = pixel[2];
    const a = pixel[3];

    if (r == 255 && g == 126 && b == 0 && a !== 0) {
        currentPattern.push([x, y]);
        ctx.lineWidth = canvas.width / 30;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }
}

{# document.getElementById('loginBtn').addEventListener('click', () => {
  ...
}); #}

document.getElementById('clearBtn').addEventListener('click', clearCanvas);

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  currentPattern = [];
}

</script>
{% endblock body %}